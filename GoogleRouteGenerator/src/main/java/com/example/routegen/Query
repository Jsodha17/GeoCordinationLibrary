SELECT f.id AS fleet_id,
       f.`name` AS fleet_name,
       l.geometry AS fleet_geom,
       ST_Distance_Sphere(l.geometry, POINT(m.m_lon, m.m_lat)) AS distance_meters
FROM asset f
JOIN `location` l ON l.id = f.location_id
CROSS JOIN (
  SELECT ST_X(l.geometry) AS m_lon, ST_Y(l.geometry) AS m_lat
  FROM asset a
  JOIN asset_model am2 ON am2.id = a.model_id
  JOIN asset_attribute aa ON aa.asset_id = a.id
  JOIN attribute_model am ON am.id = aa.attribute_model_id
  JOIN `location` l ON l.id = a.location_id
  WHERE am2.category = 'CNG_STATION'
    AND a.`name` = :mother_name
    AND am.`name` = 'D_Station_Type'
    AND aa.value = 'Mother Station'
  LIMIT 1
) AS m
WHERE f.`name` LIKE 'FlEET_%'
  AND ST_X(l.geometry) BETWEEN (m.m_lon - 0.001) AND (m.m_lon + 0.001)
  AND ST_Y(l.geometry) BETWEEN (m.m_lat - 0.001) AND (m.m_lat + 0.001)
  AND ST_Distance_Sphere(l.geometry, POINT(m.m_lon, m.m_lat)) <= 30
ORDER BY distance_meters;
